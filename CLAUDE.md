# CLAUDE.md - TTB Label Verification System

> **Project Context for AI Assistants**
>
> This document provides essential information for LLMs working on this codebase. Read this first before making changes.

---

## Project Overview

**Name:** TTB Label Verification System
**Purpose:** AI-powered web application to verify alcohol beverage labels against TTB (Alcohol and Tobacco Tax and Trade Bureau) regulatory requirements
**Scope:** Simplified compliance pre-check using OCR, NOT official TTB certification

**Key Functionality:**
- User uploads alcohol label image + fills form with product details
- Backend extracts text via OCR (Google Cloud Vision API)
- System compares extracted text with form data
- Results show field-by-field compliance status with visual highlights

---

## Tech Stack

### Frontend
- **Framework:** Next.js 14 (App Router)
- **Language:** TypeScript 5.x (strict mode)
- **Styling:** Tailwind CSS
- **State Management:** React Hook Form + Zod validation
- **HTTP Client:** Axios
- **Key Libraries:**
  - `react-dropzone` - File upload
  - `framer-motion` - Animations
  - `canvas` API - Image highlighting

### Backend
- **Runtime:** Firebase Cloud Functions (2nd gen)
- **Language:** Python 3.11
- **Package Manager:** **uv** (NOT pip, NOT poetry)
- **OCR Service:** Google Cloud Vision API (primary), Tesseract (fallback)
- **Key Libraries:**
  - `google-cloud-vision` - OCR
  - `pillow` - Image processing
  - `firebase-admin` - Firebase integration
  - `fuzzywuzzy` - Fuzzy string matching

### Infrastructure
- **Hosting:** Firebase Hosting (frontend)
- **Functions:** Firebase Cloud Functions (backend)
- **Storage:** Firebase Storage (temporary image storage, 24h retention)
- **Database:** Firestore (optional, for analytics only)

---

## File Structure

```
ttb-label-checker/
├── docs/
│   ├── prd.md                          # Product Requirements Document (SOURCE OF TRUTH)
│   ├── instructions.md                 # Original take-home assignment
│   ├── regulatoryrequirements.md       # TTB regulatory checklist (27 CFR)
│   └── sample-labels/                  # Test label images
├── frontend/
│   ├── src/
│   │   ├── app/                        # Next.js App Router pages
│   │   ├── components/                 # React components
│   │   │   ├── Form.tsx                # Product info form
│   │   │   ├── ImageUpload.tsx         # Drag-drop upload
│   │   │   └── Results.tsx             # Verification results display
│   │   ├── lib/                        # Utilities
│   │   │   ├── api.ts                  # API client
│   │   │   └── validation.ts           # Zod schemas
│   │   └── types/                      # TypeScript interfaces
│   ├── public/                         # Static assets
│   ├── package.json
│   ├── tsconfig.json
│   └── tailwind.config.js
├── functions/
│   ├── main.py                         # Firebase Cloud Function entry point
│   ├── ocr.py                          # OCR processing logic
│   ├── verification.py                 # Label verification logic
│   ├── models.py                       # Python dataclasses
│   ├── pyproject.toml                  # uv dependencies
│   ├── requirements.txt                # Generated by: uv pip compile
│   └── .python-version                 # Python version (3.11)
├── firebase.json                       # Firebase configuration
├── .firebaserc                         # Firebase project settings
├── .gitignore                          # Comprehensive ignore rules
└── CLAUDE.md                           # This file
```

---

## Critical Design Decisions

### 1. **Out of Scope (OCR Limitations)**
The following TTB requirements CANNOT be verified due to technical constraints:

- ❌ **Same Field of Vision** - Requires 3D spatial analysis of label layout
- ❌ **Visual Separation** - Requires precise positioning analysis
- ❌ **Bold/Font Styling** - OCR only extracts text content, not formatting
- ❌ **Font Size** - Cannot reliably measure point sizes from images
- ❌ **Color Requirements** - OCR processes text, not colors

**Important:** These limitations are DOCUMENTED in PRD Section 16.3. Do NOT attempt to implement spatial validation.

### 2. **Government Warning - Exact Text Required**
- Must use **95% fuzzy match** (allows minor OCR errors)
- Critical checks:
  - "GOVERNMENT WARNING" in ALL CAPS (not "Government Warning")
  - "Surgeon General" with capital S and G
  - Contains pregnancy + birth defects keywords
  - Contains driving/machinery impairment keywords
- Reference: PRD Section 3.4.1

### 3. **Conditional Requirements**
Fields are NOT always mandatory. Check conditions:

- **Age Statement:** Mandatory only if whisky < 4 years OR brandy < 2 years
- **Country of Origin:** Mandatory only if `is_imported = true`
- **Sulfite Declaration:** Mandatory only if `contains_sulfites = true` (≥10 ppm)
- **Proof:** Optional, but if present, verify Proof = ABV × 2 (±1 tolerance)

See PRD Section 3.4.3 for full logic.

### 4. **Standards of Fill**
Net contents must match TTB-approved sizes:
- Approved: 50ml, 100ml, 200ml, 375ml, 500ml, 750ml, 1L, 1.75L
- Non-standard sizes → **WARNING** (not automatic fail)

---

## Code Style & Best Practices

### TypeScript/React (Frontend)

**Naming Conventions:**
```typescript
// Components: PascalCase
export function LabelForm() { }

// Functions: camelCase
function validateField() { }

// Interfaces: PascalCase with 'I' prefix (optional)
interface LabelFormData { }

// Constants: UPPER_SNAKE_CASE
const MAX_FILE_SIZE = 10 * 1024 * 1024;
```

**Component Structure:**
```typescript
// Imports
import { useState } from 'react';
import { LabelFormData } from '@/types';

// Type definitions
interface FormProps {
  onSubmit: (data: LabelFormData) => void;
}

// Component
export function Form({ onSubmit }: FormProps) {
  // Hooks first
  const [data, setData] = useState<LabelFormData>();

  // Event handlers
  const handleSubmit = () => { };

  // Render
  return (
    <form onSubmit={handleSubmit}>
      {/* JSX */}
    </form>
  );
}
```

**Best Practices:**
- Always use TypeScript strict mode
- Prefer `interface` over `type` for object shapes
- Use Zod for runtime validation
- Extract complex logic to `/lib` utilities
- Use `async/await` over `.then()` for promises
- Add JSDoc comments for complex functions

### Python (Backend)

**Naming Conventions:**
```python
# Functions: snake_case
def verify_label(form_data, ocr_text):
    pass

# Classes: PascalCase
class FormData:
    pass

# Constants: UPPER_SNAKE_CASE
MAX_IMAGE_SIZE = 10_000_000

# Private functions: _leading_underscore
def _normalize_text(text):
    pass
```

**Function Structure:**
```python
def verify_label(form_data: FormData, ocr_text: str) -> VerificationResult:
    """
    Verify label text against form data.

    Args:
        form_data: User-submitted product information
        ocr_text: Extracted text from label image

    Returns:
        VerificationResult with field-by-field comparison

    Raises:
        ValueError: If form_data is invalid
    """
    # Validation
    if not ocr_text:
        raise ValueError("OCR text cannot be empty")

    # Processing
    results = []

    # Return
    return VerificationResult(results=results)
```

**Best Practices:**
- Use Python 3.11+ features (match/case, etc.)
- Always include type hints (PEP 484)
- Use dataclasses for data structures
- Add Google-style docstrings
- Use `Optional[T]` for nullable types
- Prefer f-strings over `.format()` or `%`

### uv Package Management (CRITICAL)

**NEVER use `pip` directly. Always use `uv`:**

```bash
# Create virtual environment
uv venv .venv

# Activate
source .venv/bin/activate  # Unix
.venv\Scripts\activate     # Windows

# Install dependencies
uv pip install package-name

# Install from pyproject.toml
uv pip install -e .

# Generate requirements.txt for Firebase
uv pip compile pyproject.toml -o requirements.txt
```

**Why uv?**
- 10-100x faster than pip
- Better dependency resolution
- Consistent with project decisions (PRD Section 5.3)

---

## API Design

### Endpoint: POST /verify-label

**Request:**
```typescript
{
  product_type: "spirits" | "wine" | "beer",
  form_data: {
    brand_name: string,
    product_class: string,
    alcohol_content: number,
    net_contents?: string,
    bottler_name?: string,
    address?: string,
    country_of_origin?: string,
    is_imported?: boolean,
    age_statement?: string,
    contains_sulfites?: boolean,
    vintage_year?: number,
    style?: string
  },
  image: string  // Base64 encoded
}
```

**Response (Success):**
```typescript
{
  status: "success",
  overall_match: boolean,
  confidence_score: number,
  results: [
    {
      field_name: string,
      status: "match" | "mismatch" | "not_found",
      expected: string,
      found: string | null,
      confidence: number,
      location?: { x, y, width, height }
    }
  ],
  ocr_full_text: string,
  processing_time_ms: number
}
```

**Response (Error):**
```typescript
{
  status: "error",
  error_code: "INVALID_IMAGE" | "OCR_FAILED" | "INVALID_INPUT",
  message: string,
  details?: any
}
```

---

## Common Tasks

### Adding a New Form Field

1. **Update TypeScript interface** (`frontend/src/types/index.ts`):
   ```typescript
   interface LabelFormData {
     // ... existing fields
     newField?: string;
   }
   ```

2. **Update Python dataclass** (`functions/models.py`):
   ```python
   @dataclass
   class FormData:
       # ... existing fields
       new_field: Optional[str] = None
   ```

3. **Add form input** (`frontend/src/components/Form.tsx`):
   ```typescript
   <input name="newField" type="text" />
   ```

4. **Add verification logic** (`functions/verification.py`):
   ```python
   def verify_new_field(form_value, ocr_text):
       # Verification logic
       pass
   ```

5. **Update PRD** if regulatory requirement changes

### Adding a New Verification Rule

1. Check PRD Section 3.4.3 for product-specific rules
2. Implement in `functions/verification.py`
3. Add test cases (manual testing minimum)
4. Document in code comments with CFR reference:
   ```python
   # Verify sulfite declaration (27 CFR 5.63(c)(7))
   if form_data.contains_sulfites:
       # Check for "Contains Sulfites" in OCR text
   ```

### Deploying to Firebase

```bash
# Frontend only
cd frontend
npm run build
firebase deploy --only hosting

# Backend only
cd functions
uv pip compile pyproject.toml -o requirements.txt
firebase deploy --only functions

# Full deployment
firebase deploy
```

---

## Testing Strategy

### Frontend Testing
- **Unit Tests:** Jest + React Testing Library
- **E2E Tests:** Cypress (optional for MVP)
- **Manual Testing:** Required with real label images

### Backend Testing
- **Unit Tests:** pytest
- **Mock OCR:** Use `pytest-mock` for Google Vision API
- **Test Cases:** See PRD Section 8.1 for required scenarios

### Test Label Images
Store in `docs/sample-labels/`:
- Exact match case (all fields correct)
- Mismatch case (wrong ABV, brand, etc.)
- Missing field case (no net contents)
- Poor quality image (test OCR error handling)

---

## Regulatory References

**Primary Documents:**
- **27 CFR Part 5** - Distilled Spirits Labeling
- **27 CFR Part 16** - Health Warning Statement
- **27 CFR Part 4** - Wine Labeling
- **27 CFR Part 7** - Beer/Malt Beverages

**Key Requirements:**
- Brand, ABV, Class/Type are CRITICAL
- Health Warning requires EXACT text (95% fuzzy match for OCR tolerance)
- Age statements have specific format requirements
- Standards of fill must match approved sizes

**See:** `docs/regulatoryrequirements.md` for complete checklist

---

## Environment Variables

**Frontend (.env.local):**
```bash
NEXT_PUBLIC_API_URL=http://localhost:5001/your-project/us-central1
NEXT_PUBLIC_FIREBASE_API_KEY=your-api-key
```

**Backend (Firebase Console or .env):**
```bash
GOOGLE_CLOUD_PROJECT_ID=ttb-label-checker
GOOGLE_APPLICATION_CREDENTIALS=path/to/service-account.json
FIREBASE_STORAGE_BUCKET=ttb-label-checker.appspot.com
OCR_CONFIDENCE_THRESHOLD=0.7
```

**NEVER commit:**
- Service account JSON files
- API keys
- `.env` files

---

## Common Pitfalls & Solutions

### 1. "Same Field of Vision" Requests
**Problem:** User asks to verify spatial positioning of fields
**Solution:** This is OUT OF SCOPE. Reference PRD Section 16.3 and explain OCR limitation.

### 2. Font/Bold Verification
**Problem:** User wants to verify "GOVERNMENT WARNING" is bold
**Solution:** OUT OF SCOPE. OCR cannot detect formatting. Verify text content only.

### 3. Age Statement Always Required?
**Problem:** Implementing age check as always mandatory
**Solution:** CONDITIONAL! Only required if whisky < 4 years OR brandy < 2 years. See PRD 3.4.3.

### 4. Using pip Instead of uv
**Problem:** Installing packages with `pip install`
**Solution:** Use `uv pip install`. Project uses uv for 10-100x speed improvement.

### 5. Exact String Match for Warning
**Problem:** Warning verification fails on minor OCR errors
**Solution:** Use 95% fuzzy match threshold, not exact match. See PRD 3.4.1.

---

## Decision Authority Hierarchy

When making implementation choices:

1. **PRD (docs/prd.md)** - Primary source of truth
2. **Regulatory Requirements (docs/regulatoryrequirements.md)** - TTB compliance rules
3. **This File (CLAUDE.md)** - Technical best practices
4. **Original Instructions (docs/instructions.md)** - Initial project scope

If conflicting information, PRD takes precedence.

---

## Key Principles

1. **Simplicity Over Perfection:** This is a 1-3 day MVP, not full TTB certification
2. **Document Limitations:** Clearly explain what OCR cannot do
3. **Regulatory Accuracy:** When verifying, be strict on critical fields (warning, ABV, brand)
4. **User Experience:** Clear error messages, visual feedback, field-by-field results
5. **Security:** Never commit credentials, sanitize inputs, validate file types

---

## Getting Help

- **PRD Questions:** Check `docs/prd.md` Section 16 (Assumptions & Constraints)
- **Regulatory Questions:** See `docs/regulatoryrequirements.md`
- **Tech Stack Questions:** Refer to official docs:
  - [Next.js Docs](https://nextjs.org/docs)
  - [Firebase Docs](https://firebase.google.com/docs)
  - [uv Docs](https://github.com/astral-sh/uv)
  - [Google Cloud Vision](https://cloud.google.com/vision/docs)

---

## Quick Start for New Contributors

```bash
# 1. Clone repository
git clone <repo-url>
cd ttb-label-checker

# 2. Frontend setup
cd frontend
npm install
npm run dev  # Starts on localhost:3000

# 3. Backend setup (separate terminal)
cd functions
uv venv .venv
source .venv/bin/activate
uv pip install -e .
functions-framework --target=verify_label --debug

# 4. Read the PRD
open docs/prd.md
```

---

**Last Updated:** 2025-10-24
**Document Version:** 1.0
**Project Status:** Pre-development (Documentation Phase Complete)
